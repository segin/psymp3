/*
 * test_flac_parser_vulnerability.cpp - Verification test for FLAC Parser OOM vulnerability
 * This file is part of PsyMP3.
 * Copyright Â© 2026 Kirn Gill <segin2005@gmail.com>
 *
 * PsyMP3 is free software. You may redistribute and/or modify it under
 * the terms of the ISC License <https://opensource.org/licenses/ISC>
 */

#include "psymp3.h"
#include "demuxer/iso/BoxParser.h"
#include "io/MemoryIOHandler.h"
#include <vector>
#include <iostream>

using namespace PsyMP3;
using namespace PsyMP3::Demuxer::ISO;
using namespace PsyMP3::IO;

int main() {
    std::cout << "Testing BoxParser FLAC Configuration Vulnerability..." << std::endl;

    // Use a large size that exceeds the new limit (16MB)
    // We use 20MB
    size_t large_size = 20 * 1024 * 1024;
    std::vector<uint8_t> buffer(large_size);

    // Fill buffer with valid-ish structure
    // Version (1 byte) = 0
    buffer[0] = 0;
    // Flags (3 bytes) = 0
    buffer[1] = 0; buffer[2] = 0; buffer[3] = 0;

    // Block 0: STREAMINFO (valid)
    // Header: Type 0 (STREAMINFO), Last Block = 0.
    buffer[4] = 0x00;
    // Length: 34 bytes (0x000022)
    buffer[5] = 0x00; buffer[6] = 0x00; buffer[7] = 0x22;
    // Body: 34 bytes of zeros (valid enough for parsing to not crash)
    // STREAMINFO is at offset 8. Ends at 8+34 = 42.

    // Block 1: PADDING (Huge)
    // Header: Type 1 (PADDING), Last Block = 1 (0x80 | 0x01 = 0x81)
    size_t padding_offset = 42;
    buffer[padding_offset] = 0x81;

    // Length: remaining size - header size (4 bytes)
    // We are just filling the buffer so read() succeeds.
    // The actual content doesn't matter much for the allocation check,
    // but having valid blocks ensures we don't fail for other reasons if we pass the size check.

    // Create MemoryIOHandler
    auto io = std::make_shared<MemoryIOHandler>(buffer.data(), buffer.size());
    BoxParser parser(io);
    AudioTrackInfo track;

    // Call ParseFLACConfiguration
    // Offset 0, Size = large_size
    // This function allocates 'size - 4' bytes.
    bool result = parser.ParseFLACConfiguration(0, large_size, track);

    if (result) {
        std::cout << "ParseFLACConfiguration returned TRUE (Allowed " << large_size << " bytes)" << std::endl;
        // Vulnerable behavior (or pre-fix behavior)
        // We want to return FAILURE (1) because we want to enforce the fix.
        std::cout << "FAILURE: Should have rejected large allocation." << std::endl;
        return 1;
    } else {
        std::cout << "ParseFLACConfiguration returned FALSE (Rejected " << large_size << " bytes)" << std::endl;
        // Secure behavior
        std::cout << "SUCCESS: Rejected large allocation." << std::endl;
        return 0;
    }
}
