/*
 * test_flac_parser_vulnerability.cpp - Verification test for FLAC BoxParser OOM vulnerability (SEC-02)
 * This file is part of PsyMP3.
 * Copyright Â© 2026 Kirn Gill <segin2005@gmail.com>
 *
 * PsyMP3 is free software. You may redistribute and/or modify it under
 * the terms of the ISC License <https://opensource.org/licenses/ISC>
 */

#include "psymp3.h"
#include "demuxer/iso/BoxParser.h"
#include "io/MemoryIOHandler.h"
#include <iostream>
#include <vector>

using namespace PsyMP3;
using namespace PsyMP3::IO;
using namespace PsyMP3::Demuxer::ISO;

int main() {
    std::cout << "Testing BoxParser FLAC Vulnerability Fix (SEC-02)..." << std::endl;

    // Create a large buffer (18MB) to simulate a large FLAC config
    // This is large enough to trigger the new limit (16MB)
    size_t large_size = 18 * 1024 * 1024;

    // Create data buffer
    std::vector<uint8_t> buffer(large_size, 0);

    // Setup valid dfLa content (minimal)
    buffer[0] = 0; // Version
    buffer[1] = 0; buffer[2] = 0; buffer[3] = 0; // Flags

    // Block 0: STREAMINFO (valid)
    buffer[4] = 0x00;
    buffer[5] = 0x00; buffer[6] = 0x00; buffer[7] = 0x22;

    // Block 1: PADDING (large)
    size_t remaining = large_size - 42;
    size_t padding_len = remaining - 4;

    buffer[42] = 0x81;
    buffer[43] = (padding_len >> 16) & 0xFF;
    buffer[44] = (padding_len >> 8) & 0xFF;
    buffer[45] = padding_len & 0xFF;

    auto io = std::make_shared<MemoryIOHandler>(buffer.data(), buffer.size());

    BoxParser parser(io);
    AudioTrackInfo track;

    // Call ParseFLACConfiguration with large size
    bool result = parser.ParseFLACConfiguration(0, large_size, track);

    if (result) {
        std::cout << "FAILURE: Large allocation was allowed!" << std::endl;
        return 1;
    } else {
        std::cout << "SUCCESS: Large allocation was rejected." << std::endl;
        return 0;
    }
}
